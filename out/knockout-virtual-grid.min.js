define(["require","exports","knockout","text!./knockout-virtual-grid.html"],function(t,e,o){e.template=t("text!./knockout-virtual-grid.html");var r=function(){function t(t){var e=this;if(console.log("[KnockoutVirtualGrid] %o",t),!t)throw new Error("Invalid params");this.dataSource=t.dataSource,this.layout=t.layout?{columns:t.layout.columns||o.observable(20),rows:t.layout.rows||o.observable(20)}:{columns:o.observable(20).extend({rateLimit:0}),rows:o.observable(20).extend({rateLimit:0})},this.offset=t.offset?{column:t.offset.column.extend({rateLimit:0})||o.observable(0).extend({rateLimit:0}),row:t.offset.row.extend({rateLimit:0})||o.observable(0).extend({rateLimit:0}),changeTracker:o.computed({read:function(){var t=e.offset.row(),o=e.offset.column();return[t,o]},deferEvaluation:!0,pure:!0,owner:this})}:{column:o.observable(0).extend({rateLimit:0}),row:o.observable(0).extend({rateLimit:0}),changeTracker:o.computed({read:function(){var t=e.offset.row(),o=e.offset.column();return[t,o]},deferEvaluation:!0,pure:!0,owner:this})},this.initialize();var r=this.dataSource(),s=this.convert(r);this.virtualGridRow(s),this.render(),this.subscriptions=[this.offset.changeTracker.subscribe(function(){return e.render()})]}return t.prototype.onNewData=function(){},t.prototype.initialize=function(){var t=this.layout.rows(),e=this.layout.columns(),r=this.dataSource&&this.dataSource.peek().length>0,s=r?this.dataSource.peek():[];r&&(t=Math.min(t,s.length),e=Math.min(e,s[0].columns.length)),this.layout.rows(t),this.layout.columns(e),console.log("[VG] initialize - rows: %d, columns: %d",t,e),this.virtualGridRow=o.observableArray([]).extend({rateLimit:0})},t.prototype.convert=function(t){if(!t||0===t.length)return[];var e,r,s,n=[],i=Math.min(t.length,this.layout.rows()),a=Math.min(t[0].columns.length,this.layout.columns()),l=Math.min(this.offset.column(),i),u=Math.min(this.offset.row(),a);console.log("[VG] convert: max rows: %d, max cols: %d, i: %d, j: %d",i,a,c,h);for(var c=l;i>c;c++){e=t[c],s=[];for(var h=u;a>h;h++)r=e.columns[h],s.push({columnIndex:h,rowIndex:c,value:o.observable(r.value),css:o.observable(r.css&&r.css.length>0?r.css.join(" "):""),readonly:o.observable(!1),metadata:{}});n.push({rowIndex:c,columns:o.observableArray(s),rowCss:o.observable(e.css&&e.css.length>0?e.css.join(" "):""),fixedColumns:o.observableArray([]),format:function(t){return t.toString()},editable:o.observable(!1)})}return console.log("[VG] convert - rows: %d",n.length),n},t.prototype.render=function(){var t=this.dataSource(),e=this.virtualGridRow();if(t&&0!==t.length){var o=this.offset.row(),r=this.offset.column(),s=Math.min(o,t.length-o),n=Math.min(r,t[0].columns.length-r),i=Math.min(this.layout.rows(),t.length),a=Math.min(this.layout.columns(),t[0].columns.length);console.log("[VG] render: max rows: %d, max cols: %d",i,a);for(var l=0,u=s;i>u;u++,l++){var c=t[u],h=e[l],m=h.columns();h.rowCss(c.css&&c.css.length>0?c.css.join(" "):"");for(var d=0,f=n;a>f;f++,d++){var v=c.columns[f],b=m[d];b.value(v.value),b.css(v.css&&v.css.length>0?v.css.join(" "):"")}}}},t.prototype.dispose=function(){for(var t=0;t<this.subscriptions.length;t++){var e=this.subscriptions[t];e&&e.dispose&&e.dispose()}this.offset.changeTracker.dispose()},t}();e.viewModel=r});