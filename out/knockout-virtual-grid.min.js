define(["require","exports","knockout","text!./knockout-virtual-grid.html","../bower_components/knockout-editable-cell/out/editableCell"],function(o,t,s){t.template=o("text!./knockout-virtual-grid.html");var e=function(){function o(o){var t=this;if(console.log("[KnockoutVirtualGrid] %o",o),!o||!o.dataSource)throw new Error("Invalid params");this.tableCss=s.observable(o.css||""),this.dataSource=o.dataSource;var e=o.dataSource(),r=this.measure(e);this.layout=new n(r.maxRows,r.maxColumns,o.offset,o.layout);var i=this.initialize(e);this.virtualGridRow=s.observableArray([]).extend({rateLimit:0}),this.virtualGridRow(i),this.render(),this.subscriptions=[this.layout.changed.subscribe(function(){return t.render()}),this.dataSource.subscribe(function(){return t.render()})]}return o.prototype.onNewData=function(o){var t=this.measure(o);t.maxRows<this.layout.rows()||t.maxColumns<this.layout.columns()?(console.log("[VG] re-initializing"),this.layout.maxRows=t.maxRows,this.layout.maxColumns=t.maxColumns,this.render()):(this.layout.maxRows=t.maxRows,this.layout.maxColumns=t.maxColumns,this.render())},o.prototype.measure=function(o){var t={maxRows:0,maxColumns:0};return o&&o.length>0&&(t.maxRows=o.length,o[0].columns&&o[0].columns.length>0&&(t.maxColumns=o[0].columns.length)),console.log("[VG] initialize: %o",t),t},o.prototype.initialize=function(o){if(!o||0===o.length)return[];var t,e,n,r=[],i=Math.min(o.length,this.layout.rows()),a=Math.min(o[0].columns.length,this.layout.columns()),u=Math.min(this.layout.column(),i),l=Math.min(this.layout.row(),a);console.log("[VG] convert: max rows: %d, max cols: %d, i: %d, j: %d",i,a,u,l);for(var c=u;i>c;c++){t=o[c],n=[];for(var m=l;a>m;m++)e=t.columns[m],n.push({columnIndex:m,rowIndex:c,value:s.observable(e.value),css:s.observable(e.css&&e.css.length>0?e.css.join(" "):""),readonly:s.observable(!1),metadata:{}});r.push({rowIndex:c,columns:s.observableArray(n),rowCss:s.observable(t.css&&t.css.length>0?t.css.join(" "):""),fixedColumns:s.observableArray([]),format:function(o){return o.toString()},editable:s.observable(!0)})}return console.log("[VG] convert - rows: %d",r.length),r},o.prototype.render=function(){var o=this.dataSource(),t=this.virtualGridRow();if(o&&0!==o.length){var s={row:this.layout.row(),column:this.layout.column()},e={row:Math.min(s.row,this.layout.maxRows-this.layout.rows()),column:Math.min(s.column,this.layout.maxColumns-this.layout.columns())},n={row:Math.min(e.row+this.layout.rows(),this.layout.maxRows),column:Math.min(e.column+this.layout.columns(),this.layout.maxColumns)};console.log("[VG] render: source: [%d, %d ], start: %o, end: %o",o.length,o[0].columns.length,e,n);for(var r=0,i=e.row;i<n.row;i++,r++){var a=o[i],u=t[r],l=u.columns();u.rowCss(a.css&&a.css.length>0?a.css.join(" "):"");for(var c=0,m=e.column;m<n.column;m++,c++){var h=a.columns[m],d=l[c];d.value(h.value),d.css(h.css&&h.css.length>0?h.css.join(" "):"")}}}},o.prototype.dispose=function(){for(var o=0;o<this.subscriptions.length;o++){var t=this.subscriptions[o];t&&t.dispose&&t.dispose()}this.layout.dispose()},o}();t.viewModel=e;var n=function(){function o(o,t,e,n){var r=this;this.maxRows=o,this.maxColumns=t;var i,a=[];a.push(e&&e.row?e.row:s.observable(0)),a.push(e&&e.column?e.column:s.observable(0)),n&&n.rows?a.push(n.rows):(i=Math.min(25,this.maxRows),a.push(s.observable(i))),n&&n.columns?a.push(n.columns):(i=Math.min(35,this.maxColumns),a.push(s.observable(i))),this.row=s.computed({read:function(){var o=a[0],t=o();return console.log("[VG] layout - row: %d",t),t},write:function(o){var t=r.maxRows-r.rows();a[0](0>o||isNaN(o)?0:o>=0&&t+1>o?o:t)},deferEvaluation:!0,owner:this}).extend({rateLimit:0}),this.column=s.computed({read:function(){return a[1]()},write:function(o){var t=r.maxColumns-r.columns();a[1](0>o||isNaN(o)?0:o>=0&&t+1>o?o:t)},deferEvaluation:!0,owner:this}).extend({rateLimit:0}),this.rows=s.computed({read:function(){return a[2]()},deferEvaluation:!0,owner:this}).extend({rateLimit:0}),this.columns=s.computed({read:function(){return a[3]()},deferEvaluation:!0,owner:this}).extend({rateLimit:0}),this.changed=s.computed({read:function(){return[r.row(),r.column(),r.rows(),r.columns()]},owner:this,pure:!0,deferEvaluation:!0}).extend({rateLimit:0})}return o.prototype.dispose=function(){this.row.dispose(),this.column.dispose(),this.rows.dispose(),this.columns.dispose(),this.changed.dispose()},o}();t.LayoutOffsetHelper=n});