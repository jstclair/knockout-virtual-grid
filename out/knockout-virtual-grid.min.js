define(["require","exports","knockout","text!./knockout-virtual-grid.html"],function(o,t,s){t.template=o("text!./knockout-virtual-grid.html");var e=function(){function o(o){var t=this;if(console.log("[KnockoutVirtualGrid] %o",o),!o||!o.dataSource)throw new Error("Invalid params");this.tableCss=s.observable(o.css||""),this.dataSource=o.dataSource;var e=o.dataSource(),n=this.initialize(e);this.layout=new r(n.maxRows,n.maxColumns,o.offset,o.layout);var i=this.convert(e);this.virtualGridRow=s.observableArray([]).extend({rateLimit:0}),this.virtualGridRow(i),this.render(),this.subscriptions=[this.layout.changed.subscribe(function(){return t.render()}),this.dataSource.subscribe(function(){return t.render()})]}return o.prototype.onNewData=function(o){var t=this.initialize(o);t.maxRows<this.layout.rows()||t.maxColumns<this.layout.columns()?console.log("[VG] re-initializing"):this.render()},o.prototype.initialize=function(o){var t={maxRows:o.length,maxColumns:o[0].columns.length};return console.log("[VG] initialize: %o",t),t},o.prototype.convert=function(o){if(!o||0===o.length)return[];var t,e,r,n=[],i=Math.min(o.length,this.layout.rows()),a=Math.min(o[0].columns.length,this.layout.columns()),l=Math.min(this.layout.column(),i),u=Math.min(this.layout.row(),a);console.log("[VG] convert: max rows: %d, max cols: %d, i: %d, j: %d",i,a,l,u);for(var c=l;i>c;c++){t=o[c],r=[];for(var h=u;a>h;h++)e=t.columns[h],r.push({columnIndex:h,rowIndex:c,value:s.observable(e.value),css:s.observable(e.css&&e.css.length>0?e.css.join(" "):""),readonly:s.observable(!1),metadata:{}});n.push({rowIndex:c,columns:s.observableArray(r),rowCss:s.observable(t.css&&t.css.length>0?t.css.join(" "):""),fixedColumns:s.observableArray([]),format:function(o){return o.toString()},editable:s.observable(!1)})}return console.log("[VG] convert - rows: %d",n.length),n},o.prototype.render=function(){var o=this.dataSource(),t=this.virtualGridRow();if(o&&0!==o.length){var s=this.layout.row(),e=this.layout.column(),r=Math.min(s,o.length-this.layout.rows()),n=Math.min(e,o[0].columns.length-this.layout.columns()),i=Math.min(r+this.layout.rows(),o.length),a=Math.min(n+this.layout.columns(),o[0].columns.length);console.log("[VG] render: source - rows: %d, cols: %d",o.length,o[0].columns.length),console.log("[VG] render: start - row: %d, col: %d",r,n),console.log("[VG] render: end   - row: %d, col: %d",i,a);for(var l=0,u=r;i>u;u++,l++){var c=o[u],h=t[l],d=h.columns();h.rowCss(c.css&&c.css.length>0?c.css.join(" "):"");for(var m=0,v=n;a>v;v++,m++){var w=c.columns[v],p=d[m];p.value(w.value),p.css(w.css&&w.css.length>0?w.css.join(" "):"")}}}},o.prototype.dispose=function(){for(var o=0;o<this.subscriptions.length;o++){var t=this.subscriptions[o];t&&t.dispose&&t.dispose()}this.layout.dispose()},o}();t.viewModel=e;var r=function(){function o(o,t,e,r){var n=this;this.maxRows=o,this.maxColumns=t;var i,a=[];a.push(e&&e.row?e.row:s.observable(0)),a.push(e&&e.column?e.column:s.observable(0)),r&&r.rows?a.push(r.rows):(i=Math.min(25,this.maxRows),a.push(s.observable(i))),r&&r.columns?a.push(r.columns):(i=Math.min(35,this.maxColumns),a.push(s.observable(i))),this.row=s.computed({read:function(){var o=a[0],t=o();return console.log("[VG] layout - row: %d",t),t},write:function(o){var t=n.maxRows-n.rows();a[0](0>o||isNaN(o)?0:o>=0&&t+1>o?o:t)},deferEvaluation:!0,owner:this}).extend({rateLimit:0}),this.column=s.computed({read:function(){return a[1]()},write:function(o){var t=n.maxColumns-n.columns();a[1](0>o||isNaN(o)?0:o>=0&&t+1>o?o:t)},deferEvaluation:!0,owner:this}).extend({rateLimit:0}),this.rows=s.computed({read:function(){return a[2]()},deferEvaluation:!0,owner:this}).extend({rateLimit:0}),this.columns=s.computed({read:function(){return a[3]()},deferEvaluation:!0,owner:this}).extend({rateLimit:0}),this.changed=s.computed({read:function(){return[n.row(),n.column(),n.rows(),n.columns()]},owner:this,pure:!0,deferEvaluation:!0}).extend({rateLimit:0})}return o.prototype.dispose=function(){this.row.dispose(),this.column.dispose(),this.rows.dispose(),this.columns.dispose(),this.changed.dispose()},o}();t.LayoutOffsetHelper=r});